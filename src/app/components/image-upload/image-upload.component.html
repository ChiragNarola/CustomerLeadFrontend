<div class="modal-overlay" *ngIf="isOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- Modal Header -->
    <div class="modal-header">
      <h2>Upload Images for {{ customer?.name }}</h2>
      <button class="close-btn" (click)="closeModal()" [disabled]="isUploading">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">

      <!-- Uploaded Images Carousel Section -->
      <div class="uploaded-images-section" *ngIf="customer">
        <div class="section-header">
          <h3>Uploaded Images ({{ uploadedImages.length }})</h3>
          <button class="refresh-btn" (click)="loadUploadedImages()" [disabled]="isLoadingImages">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" [class.spinning]="isLoadingImages">
              <path d="M3 12A9 9 0 0 1 12 3A9 9 0 0 1 21 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 12A9 9 0 0 1 12 21A9 9 0 0 1 3 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Refresh
          </button>
        </div>

        <!-- Loading State -->
        <div class="loading-state" *ngIf="isLoadingImages">
          <div class="spinner"></div>
          <p>Loading images...</p>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="!isLoadingImages && uploadedImages.length === 0">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <circle cx="8.5" cy="8.5" r="1.5" stroke="currentColor" stroke-width="2"/>
            <path d="M21 15L16 10L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p>No images uploaded yet</p>
        </div>

        <!-- Carousel: 2 images per view -->
        <div class="carousel" *ngIf="!isLoadingImages && uploadedImages.length > 0">
          <div class="carousel-wrapper">
            <button class="carousel-btn prev" (click)="prevImage()">&lt;</button>

            <div class="carousel-images-container">
              <div class="carousel-image-item" 
                   *ngFor="let img of uploadedImages | slice:currentImageIndex:currentImageIndex+2">
                <img [src]="getImageUrl(img)" [alt]="'Image ' + img.id" loading="lazy">

                <button class="delete-btn" 
                        (click)="deleteImage(img)" 
                        [disabled]="isDeletingImage && deletingImageId === img.id">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" *ngIf="!(isDeletingImage && deletingImageId === img.id)">
                    <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 6V4A2 2 0 0 1 10 2H14A2 2 0 0 1 16 4V6M19 6V20A2 2 0 0 1 17 22H7A2 2 0 0 1 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" *ngIf="isDeletingImage && deletingImageId === img.id" class="spinning">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 2A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </div>

            <button class="carousel-btn next" (click)="nextImage()">&gt;</button>
          </div>
        </div>

      </div>

      <!-- File Upload Area -->
      <div class="upload-area" 
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)"
           [class.drag-over]="false">
        <div class="upload-content">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h3>Drag & Drop Images Here</h3>
          <p>or</p>
          <label for="file-input" class="file-input-label">
            <span>Choose Files</span>
            <input id="file-input" type="file" multiple accept="image/*" 
                   (change)="onFileSelected($event)" [disabled]="isUploading">
          </label>
          <p class="file-info">Supports: JPG, PNG, GIF, WebP (Max 10MB each)</p>
        </div>
      </div>

      <!-- Selected Files Preview -->
      <div class="file-preview" *ngIf="selectedFiles.length > 0">
        <h3>Selected Images ({{ selectedFiles.length }})</h3>
        <div class="preview-grid">
          <div class="preview-item" *ngFor="let file of selectedFiles; let i = index">
            <div class="preview-image">
              <img [src]="previewUrls[i]" [alt]="file.name">
              <button class="remove-btn" (click)="removeFile(i)" [disabled]="isUploading">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <div class="file-info">
              <p class="file-name">{{ file.name }}</p>
              <p class="file-size">{{ formatFileSize(file.size) }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Progress -->
      <div class="upload-progress" *ngIf="isUploading">
        <div class="progress-header">
          <h3>Uploading Images...</h3>
          <span>{{ uploadProgress }}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="uploadProgress"></div>
        </div>
      </div>

      <!-- Messages -->
      <div class="message error" *ngIf="error">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>{{ error }}</span>
      </div>

      <div class="message success" *ngIf="success">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>{{ success }}</span>
      </div>

    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()" [disabled]="isUploading">
        Cancel
      </button>
      <button class="btn btn-primary" (click)="uploadImages()" [disabled]="selectedFiles.length === 0 || isUploading">
        {{ isUploading ? 'Uploading...' : 'Upload Images' }}
      </button>
    </div>

  </div>
</div>
